name: üöÄ Deploy to Digital Ocean

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  deploy:
    name: üöÄ Deploy to Digital Ocean
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      
    - name: üîê Setup SSH
      run: |
        # Create SSH directory
        mkdir -p ~/.ssh
        
        # Write SSH key to file with proper formatting (handle base64 if needed)
        echo "${{ secrets.DEPLOY_SSH_KEY }}" | tr ' ' '\n' > ~/.ssh/deploy_key_raw
        
        # Check if it's base64 encoded or already formatted
        if grep -q "BEGIN OPENSSH PRIVATE KEY" ~/.ssh/deploy_key_raw; then
          # Already properly formatted
          cp ~/.ssh/deploy_key_raw ~/.ssh/deploy_key
        else
          # Try to decode from base64 or fix formatting
          echo "${{ secrets.DEPLOY_SSH_KEY }}" | sed 's/-----BEGIN OPENSSH PRIVATE KEY-----/&\n/' | sed 's/-----END OPENSSH PRIVATE KEY-----/\n&/' | sed 's/\([A-Za-z0-9+\/]\{64\}\)/&\n/g' > ~/.ssh/deploy_key
        fi
        
        # Ensure proper line endings
        sed -i 's/\r$//' ~/.ssh/deploy_key
        
        # Set proper permissions
        chmod 600 ~/.ssh/deploy_key
        
        # Debug: check key format
        echo "SSH key format check:"
        head -1 ~/.ssh/deploy_key
        tail -1 ~/.ssh/deploy_key
        
        # Debug environment variables
        echo "DEPLOY_HOST value: [${{ secrets.DEPLOY_HOST }}]"
        echo "DEPLOY_USER value: [${{ secrets.DEPLOY_USER }}]"
        
        # Add host to known_hosts to avoid prompts
        HOST_IP="${{ secrets.DEPLOY_HOST }}"
        echo "Adding host $HOST_IP to known_hosts"
        ssh-keyscan -H "$HOST_IP" >> ~/.ssh/known_hosts || echo "ssh-keyscan failed, continuing anyway"
        
    - name: üîç Verify server connection
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "echo 'Connection successful'"
        
    - name: üì§ Deploy application
      run: |
        # Create deployment directory if it doesn't exist
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "mkdir -p ${{ secrets.DEPLOY_PATH }}"
        
        # Sync files to server (excluding sensitive files)
        rsync -avz --delete \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          --exclude '.git' \
          --exclude 'node_modules' \
          --exclude '.env*' \
          --exclude 'data/database/*.db' \
          --exclude 'data/uploads' \
          --exclude '.next' \
          ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/
          
    - name: üîß Setup environment and deploy
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          cd ${{ secrets.DEPLOY_PATH }}
          
          # Create environment file from secrets
          cat > .env.local << 'ENVEOF'
        DATABASE_URL="${{ secrets.DATABASE_URL }}"
        JWT_SECRET="${{ secrets.JWT_SECRET }}"
        ADMIN_EMAIL="${{ secrets.ADMIN_EMAIL }}"
        ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}"
        NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"
        NODE_ENV="production"
        ENVEOF
          
          # Make scripts executable
          chmod +x *.sh
          
          # Run deployment
          ./deploy.sh
        EOF
        
    - name: üîç Verify deployment
      run: |
        # Wait for application to start
        sleep 30
        
        # Check if application is responding
        curl -f ${{ secrets.NEXTAUTH_URL }} || exit 1
        curl -f ${{ secrets.NEXTAUTH_URL }}/api/recipes || exit 1
        
        echo "‚úÖ Deployment successful!"
        
    - name: üìä Post-deployment cleanup
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          # Clean up old Docker images
          docker system prune -f
          
          # Create backup after successful deployment
          cd ${{ secrets.DEPLOY_PATH }}
          ./backup.sh
        EOF
        
    - name: üì¢ Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Chang Cookbook deployed successfully to ${{ secrets.NEXTAUTH_URL }}"
        else
          echo "‚ùå Deployment failed"
          exit 1
        fi